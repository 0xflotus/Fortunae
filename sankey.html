<!DOCTYPE html>
<html style="border-radius: 5px;">
  <head>
    <meta charset="UTF-8" />
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!-- <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    /> -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@100;400;500;700&display=swap");
    </style>

    <link rel="stylesheet" type="text/css" href="./client/css/chart.css" />
    <style>
      body {
        /* min-height: 100vh;
        width: 100%; */
        overflow: hidden;
      }

      header {
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 2px;
      }

      .container {
        max-width: 800px;
        margin: 1rem auto;
        border-radius: 2px;
        background: #000;
      }
      .container div {
        margin-bottom: 1.5rem;
      }
      .container p {
        margin: 0.8rem 0 0.4rem;
      }
      .container a {
        color: inherit;
      }
      .container #tooltip {
        pointer-events: none;
        position: absolute;
        opacity: 0;
        padding: 1rem;
        box-shadow: 0 0 4px rgba(66, 66, 78, 0.2);
        background: #000;
        line-height: 2;
        transition: all 0.2s ease-out;
      }

      .application-nav {
        position: absolute;
        padding: 20px;
        width: 80%;
        text-align: right;
        height: 50px;
      }

      #close-window {
        position: absolute;
        z-index: 1000;
        top: 20px;
        right: 20px;
      }
    </style>
    <title>Fortunae</title>
  </head>
  <body>
    <button id="close-window">
      <img
        style="z-index: 1000;"
        src="./client/images/close.svg"
        width="12px"
      />
    </button>
    <div class="application-nav" style="-webkit-app-region: drag;"></div>
    <header style="padding: 40px 0 0 0; text-align: center;">
      MONTHLY EXPENSES
    </header>
    <div class="container"></div>
    <script type="text/javascript" src="./client/library/d3.js"></script>
    <script src="https://unpkg.com/d3-array@1"></script>
    <script src="https://unpkg.com/d3-collection@1"></script>
    <script src="https://unpkg.com/d3-path@1"></script>
    <script src="https://unpkg.com/d3-shape@1"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>
    <script>
      require("./renderer.js");
    </script>
    <!-- <script type="module" src="./client/js/largeChart.js"></script> -->
    <!-- <script src="./client/js/chart.js"></script> -->
    <!-- <script type="module" src="./client/js/historyChart.js"></script> -->
    <script>
      document.addEventListener("keydown", function (e) {
        if (e.which === 123) {
          require("remote").getCurrentWindow().toggleDevTools();
        } else if (e.which === 116) {
          location.reload();
        }
      });
    </script>

    <script>
      /* globals d3 */
      const container = d3.select(".container");

      // BEGIN NODE ALGORITHSM
      const data = JSON.parse(localStorage.getItem("items"));
      console.log(data);
      incomeSources = [];
      expenseSources = [];
      savingSources = [];

      data.forEach((item) => {
        if (item.category == "4") {
          incomeSources.push({
            item,
          });
        } else if (item.category == "2" && item.type !== "Savings") {
          console.log(item);
          expenseSources.push({
            item,
          });
        } else if (item.category == "2" && item.type == "Savings") {
          console.log(item);
          savingSources.push({ item });
        }
      });
      nodes = [];
      incomeSources.forEach((item) => {
        nodes.push({ name: item.item.title });
      });

      nodes.push({ name: "Income" }, { name: "Expenses" });
      if (savingSources.length) {
        nodes.push({ name: "Savings" });
      }

      expenseSources.forEach((item) => {
        nodes.push({ name: item.item.title });
      });

      savingSources.forEach((item) => {
        nodes.push({ name: item.item.title });
      });

      links = [];
      totalIncome = [];
      incomeSources.forEach((item, index) => {
        links.push({
          source: index,
          target: incomeSources.length,
          value: Number(item.item.amount),
        });
        totalIncome.push(Number(item.item.amount));
      });

      links.push({
        source: incomeSources.length,
        target: incomeSources.length + 1,
        value: totalIncome.reduce((a, b) => a + b, 0),
      });

      totalSavings = [];
      if (savingSources.length) {
        savingSources.forEach((item) => {
          totalSavings.push(Number(item.item.amount));
        });
        links.push({
          source: incomeSources.length,
          target: incomeSources.length + 2,
          value: totalSavings.reduce((a, b) => a + b, 0),
        });
      }

      console.log(expenseSources);
      const expenseStartingPoint = links.length;
      expenseSources.forEach((item, index) => {
        links.push({
          source: expenseStartingPoint - 1,
          target: index + 1 + expenseStartingPoint,
          value: Number(item.item.amount),
        });
      });

      const savingsStartingPoint = links.length;
      console.log(savingsStartingPoint);
      savingSources.forEach((item, index) => {
        links.push({
          source: incomeSources.length + 2,
          target: index + 1 + savingsStartingPoint,
          value: Number(item.item.amount),
        });
      });
      // console.log(savingSources);

      console.log(links);

      // END NODE ALGORITHM

      const sampleData = {
        nodes,
        links,
        // nodes: [
        //   { name: "Wages" },
        //   { name: "Interest" },
        //   { name: "Reimbursements" },
        //   { name: "Miscellaneous" },
        //   { name: "Income" },
        //   { name: "Expenses" },
        //   { name: "Savings" },
        //   { name: "Rent" },
        //   { name: "Internet" },
        //   { name: "Utilities" },
        //   { name: "Council Tax" },
        //   { name: "Gym" },
        //   { name: "Food" },
        //   { name: "Social" },
        //   { name: "Other" },
        //   { name: "Travel" },
        //   { name: "ISA" },
        //   { name: "Emergency Fund" },
        // ],
        // links: [
        //   { source: 0, target: 4, value: 24111.53 },
        //   { source: 1, target: 4, value: 78.21 },
        //   { source: 2, target: 4, value: 1393.35 },
        //   { source: 3, target: 4, value: 2.2 },
        //   { source: 4, target: 5, value: 17208.61 },
        //   { source: 4, target: 6, value: 8376.68 },
        //   { source: 5, target: 7, value: 8100 },
        //   { source: 5, target: 8, value: 285.05 },
        //   { source: 5, target: 9, value: 501.35 },
        //   { source: 5, target: 10, value: 985.78 },
        //   { source: 5, target: 11, value: 162.0 },
        //   { source: 5, target: 12, value: 1188.38 },
        //   { source: 5, target: 13, value: 1147.75 },
        //   { source: 5, target: 14, value: 1788.4 },
        //   { source: 5, target: 15, value: 3049.7 },
        //   { source: 6, target: 16, value: 2400.0 },
        //   { source: 6, target: 17, value: 5976.68 },
        // ],
      };
      const tooltip = container.append("div").attr("id", "tooltip");

      // SVG frame
      // the same margin, width and height are used for both visualizations
      const margin = {
        top: 20,
        right: 20,
        bottom: 20,
        left: 20,
      };

      const width = 600 + (margin.left + margin.right);
      const height = 500 + (margin.top + margin.bottom);

      const containerFrame = container
        .append("svg")
        .attr(
          "viewBox",
          `0 0 ${width + (margin.left + margin.right)} ${
            height + (margin.top + margin.bottom)
          }`
        )
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

      createSankeyDiagram(sampleData, containerFrame);
      // function creating the sankey diagram, based on an input data and frame (in which the visualization is plotted)
      function createSankeyDiagram(sampleData, frame) {
        // detail a color scale
        var COLOURS = ["#fff"];
        const color = d3.scaleOrdinal(COLOURS);

        // detail the sankey function
        const sankey = d3
          .sankey()
          // limit the nodes and links within the containing group
          .extent([
            [0, 0],
            [width, height],
          ]);

        // destructure the two arrays for the nodes and links in two variables
        const { nodes, links } = sankey(sampleData);

        // detail in a defs block one linear gradient for each link
        // detail a unique identifier as to later call the id with the specified index
        const defs = frame.append("defs");

        const linearGradients = defs
          .selectAll("linearGradient")
          .data(links)
          .enter()
          .append("linearGradient")
          .attr("id", (d) => `gradient${d.index}`)
          .attr("x1", "0%")
          .attr("y1", "50%")
          .attr("x2", "100%")
          .attr("y2", "50%");

        // linear gradient going from left to right and detailing a color based on the source and target values
        linearGradients
          .append("stop")
          .attr("offset", "100%")
          .attr("stop-color", (d) => color("#fff"));

        linearGradients
          .append("stop")
          .attr("offset", "100%")
          .attr("stop-color", (d) => color("#fff"));

        // detail a generator function for the links
        const sankeyLinks = d3.sankeyLinkHorizontal();

        // append a path element for each link
        // using the generator function
        frame
          .selectAll("path.link")
          .data(links)
          .enter()
          .append("path")
          .attr("class", "link")
          .attr("d", sankeyLinks)
          .attr("fill", "none")
          // stroke using the gradient
          .attr("stroke", (d) => "#fff")
          // stroke width based on the width of each data point
          .attr("stroke-width", (d) => "3px")
          // alter the opacity on hover
          // detail also the data through a simple tooltip
          .attr("opacity", 0.2)
          .on("mouseenter", function (d) {
            d3.select(this).transition().attr("opacity", 0.8);

            tooltip
              .append("p")
              .html(
                `<strong>${d.source.name}</strong> - <strong>${d.target.name}</strong>`
              );

            tooltip.append("p").html(`Value: <strong>${d.value}</strong>`);

            tooltip
              .style("opacity", 1)
              .style("left", `${d3.event.pageX}px`)
              .style("top", `${d3.event.pageY}px`);
          })
          .on("mouseout", function () {
            d3.select(this).transition().attr("opacity", 0.2);

            tooltip.style("opacity", 0).selectAll("p").remove();
          });

        // append a rectangle for each node
        // using the fabricated values and the color based on the index
        frame
          .selectAll("rect.node")
          .data(nodes)
          .enter()
          .append("rect")
          .attr("class", "node")
          .attr("x", (d) => d.x0)
          .attr("y", (d) => d.y0)
          .attr("width", 2)
          .attr("height", (d) => d.y1 - d.y0)
          .attr("pointer-events", "none")
          //.attr("stroke", "#555")
          //.attr("stroke-width", "4px")
          .attr("fill", (d) => color(d.index));

        // for each node append also a text element, detailing the respective value
        // horizontally position the text after or before the rectangle elements for each node
        frame
          .selectAll("text.node")
          .data(nodes)
          .enter()
          .append("text")
          .text((d) => d.name)
          .attr("font-size", "14")
          .attr("fill", "#fff")
          .attr("x", (d) => {
            if (d.sourceLinks.length > 0) {
              return d.x0 + sankey.nodeWidth() + 10;
            }
            return d.x0 - 5;
          })
          .attr("y", (d) => (d.y1 + d.y0) / 2)
          .attr("pointer-events", "none")
          .attr("alignment-baseline", "middle")
          .attr("text-anchor", (d) =>
            d.sourceLinks.length > 0 ? "start" : "end"
          );
      }
    </script>
    <script>
      const remote = require("electron").remote;
      document
        .getElementById("close-window")
        .addEventListener("click", function (e) {
          var window = remote.getCurrentWindow();
          window.close();
        });
    </script>
  </body>
</html>
